name: Build Win7 (thongtech/go-legacy-win7)

on:
  workflow_dispatch:
    inputs:
      upload_tag:
        description: "上传到哪个 Release tag (如 v1.8.24-win7，留空则只生成 artifact)"
        required: false
        default: ""
      go_legacy_version:
        description: "go-legacy-win7 版本 (如 1.26.0-1，留空用最新)"
        required: false
        default: "latest"

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            assetname: win7-64
          - goos: windows
            goarch: 386
            assetname: win7-32
      fail-fast: false

    runs-on: ubuntu-latest
    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      CGO_ENABLED: 0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: win7-build
          fetch-depth: 0

      - name: Resolve go-legacy-win7 version
        id: resolve
        run: |
          INPUT_VER="${{ github.event.inputs.go_legacy_version }}"
          if [ -z "$INPUT_VER" ] || [ "$INPUT_VER" = "latest" ]; then
            TAG=$(curl -sL https://api.github.com/repos/thongtech/go-legacy-win7/releases/latest | jq -r '.tag_name')
          else
            TAG="v${INPUT_VER}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using go-legacy-win7 $TAG"

      - name: Setup go-legacy-win7
        run: |
          VERSION="${{ steps.resolve.outputs.version }}"
          URL="https://github.com/thongtech/go-legacy-win7/releases/download/v${VERSION}/go-legacy-win7-${VERSION}.linux_amd64.tar.gz"
          echo "Downloading: $URL"
          wget -q "$URL" -O go-legacy-win7.tar.gz
          sudo mkdir -p /usr/local/go-legacy-win7
          sudo tar -C /usr/local -xzf go-legacy-win7.tar.gz
          echo "GOROOT=/usr/local/go-legacy-win7" >> $GITHUB_ENV
          echo "/usr/local/go-legacy-win7/bin" >> $GITHUB_PATH

      - name: Verify Go version
        run: |
          go version
          go env GOROOT

      - name: Get project dependencies
        run: go mod download

      - name: Build Xray
        run: |
          mkdir -p build_assets
          COMMID=$(git describe --always --dirty)
          echo "Building Xray (Win7) ${{ matrix.assetname }}..."
          go build -o build_assets/xray.exe -trimpath -buildvcs=false \
            -gcflags="all=-l=4" \
            -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" \
            -v ./main

      - name: Prepare release assets
        run: |
          cp ${GITHUB_WORKSPACE}/README.md ./build_assets/README.md
          cp ${GITHUB_WORKSPACE}/LICENSE ./build_assets/LICENSE

      - name: Create ZIP archive
        run: |
          pushd build_assets || exit 1
          touch -mt $(date +%Y01010000) *
          zip -9vr ../Xray-${{ matrix.assetname }}.zip .
          popd || exit 1
          FILE=./Xray-${{ matrix.assetname }}.zip
          DGST=$FILE.dgst
          for METHOD in {"md5","sha1","sha256","sha512"}; do
            openssl dgst -$METHOD $FILE | sed 's/([^)]*)//g' >> $DGST
          done

      - name: Upload to release
        if: github.event.inputs.upload_tag != ''
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./Xray-${{ matrix.assetname }}.zip*
          tag: ${{ github.event.inputs.upload_tag }}
          file_glob: true
          overwrite: true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Xray-${{ matrix.assetname }}
          path: ./build_assets/*
